# CornerTime 开发日志

## 项目概述
CornerTime 是一个 macOS 浮层时钟应用，能够在任何情况下（全屏应用、菜单栏隐藏、切换空间/桌面、演示模式）稳定显示时间。

## 开发进度

### ✅ 第一阶段：项目基础架构（2025-08-12）

#### 已完成功能
1. **项目架构搭建**
   - ✅ MVVM 模式架构
   - ✅ 模块化设计（6个核心模块）
   - ✅ 依赖注入和协议导向编程

2. **核心模块实现**
   - ✅ ClockCore：时间逻辑、格式化、多时区处理
   - ✅ WindowManager：窗口层级、位置管理、空间行为
   - ✅ PreferencesManager：配置读写、持久化存储
   - ✅ DisplayManager：多显示器检测、拓扑变化监听
   - ✅ HotKeyManager：全局快捷键注册与处理
   - ✅ AppLifecycle：启动项管理、应用状态控制

3. **基础浮层窗口**
   - ✅ 置顶透明窗口创建
   - ✅ 时间显示和格式化
   - ✅ SwiftUI + AppKit 混合架构
   - ✅ 基础的窗口控制器

4. **代码质量优化**
   - ✅ 修复所有编译错误
   - ✅ MainActor 异步调用优化
   - ✅ 整数溢出安全处理
   - ✅ 窗口层级安全设置

### 🚧 第二阶段：MVP 核心功能开发（进行中）

#### 当前任务
- 🔄 **全屏应用和多空间可见功能**
  - 实现窗口在全屏应用中保持可见
  - 支持 Mission Control 多桌面切换
  - 确保空间行为设置正确工作

#### 待开发功能（按优先级）
1. **位置记忆、拖拽、吸附和安全区支持**
2. **点击穿透和位置锁定功能**
3. **基础外观控制**（字体大小、12/24h、秒/日期）
4. **多显示器基础支持**
5. **全局快捷键功能**
6. **开机启动功能**
7. **截图/录屏排除功能**

## 技术架构

### 技术栈
- **语言**: Swift 5
- **UI框架**: SwiftUI + AppKit
- **架构模式**: MVVM
- **最低支持**: macOS 15.5
- **开发环境**: Xcode 16

### 模块结构
```
CornerTime/
├── Core/                   # 核心业务逻辑
│   ├── ClockCore.swift     # 时间处理核心
│   ├── WindowManager.swift # 窗口管理
│   ├── PreferencesManager.swift # 偏好设置
│   ├── DisplayManager.swift # 显示器管理
│   ├── HotKeyManager.swift # 快捷键管理
│   └── AppLifecycle.swift  # 应用生命周期
├── ViewModels/             # 视图模型
│   └── ClockViewModel.swift
├── Views/                  # 视图层
│   ├── ClockView.swift     # 时钟显示视图
│   └── ClockWindowController.swift # 窗口控制器
└── CornerTimeApp.swift     # 应用入口
```

### 关键技术实现

#### 窗口层级设置
```swift
// 使用 .statusBar 层级确保在全屏应用上方可见
window.level = .statusBar

// 空间行为设置支持全屏和多空间
window.collectionBehavior = [
    .canJoinAllSpaces,      // 出现在所有空间
    .fullScreenAuxiliary,   // 在全屏空间中辅助显示
    .stationary,            // 保持位置
    .ignoresCycle           // 不参与窗口循环
]
```

#### 安全编程实践
- 整数溢出保护（哈希值处理）
- MainActor 正确使用
- 可选值安全处理
- 内存管理优化

## 开发里程碑

### 已完成
- [x] **2025-08-12**: 项目基础架构搭建完成
- [x] **2025-08-12**: 所有核心模块基础实现完成
- [x] **2025-08-12**: 基础浮层窗口功能实现
- [x] **2025-08-12**: 代码质量优化和安全性修复

### 计划中
- [ ] **2025-08-12**: 全屏应用和多空间可见功能
- [ ] **2025-08-12**: 位置管理和拖拽功能
- [ ] **2025-08-12**: 点击穿透和锁定功能
- [ ] **2025-08-13**: 外观控制和快捷键功能
- [ ] **2025-08-13**: MVP 版本完成

## 技术挑战与解决方案

### 已解决
1. **编译错误修复**
   - 问题：Codable 协议冲突、MainActor 异步调用
   - 解决：重构数据结构、正确使用 @MainActor 标记

2. **窗口层级问题**
   - 问题：使用过时的 CGWindowLevelForKey API
   - 解决：改用现代的 NSWindow.Level.statusBar

3. **整数溢出风险**
   - 问题：哈希值转换可能导致溢出
   - 解决：安全的位运算和类型转换

### 待解决
1. **全屏应用兼容性**
2. **多显示器同步**
3. **性能优化**

## 测试计划

### 功能测试
- [ ] 基础时钟显示
- [ ] 全屏应用可见性
- [ ] 多桌面切换
- [ ] 窗口拖拽和定位
- [ ] 快捷键响应

### 兼容性测试
- [ ] 不同 macOS 版本
- [ ] 多种硬件配置
- [ ] 第三方全屏应用

### 性能测试
- [ ] 内存占用监控
- [ ] CPU 使用率
- [ ] 电池续航影响

---

**最后更新**: 2025-08-12  
**当前版本**: 0.1.0-alpha  
**开发状态**: 活跃开发中