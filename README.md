# CornerTime

轻量、稳定的 macOS 浮层时钟应用。在任何情况下（全屏应用、菜单栏隐藏、切换空间/桌面、演示模式）都能保持可见，且尽量不打扰你的前台工作流。

> 当前版本：0.2.0-alpha · 开发状态：活跃开发中（见 [开发日志](开发日志.md)）

---

## 目录
- [主要特性](#主要特性)
- [安装与构建](#安装与构建)
- [使用指南](#使用指南)
- [设置项（偏好）](#设置项偏好)
- [多显示器支持](#多显示器支持)
- [架构与目录结构](#架构与目录结构)
- [技术要点](#技术要点)
- [路线图](#路线图)
- [更新日志与问题修复](#更新日志与问题修复)
- [贡献](#贡献)
- [许可证](#许可证)

---

## 主要特性
- 全屏与多空间可见：在全屏 App 与各个桌面空间中保持显示
- 置顶透明窗口：使用较高窗口层级，避免被遮挡
- 自由拖拽 + 吸附 + 位置记忆 + 安全区避让（刘海/系统 UI）
- 点击穿透：开启后不拦截鼠标事件，避免影响前景应用
- 位置锁定：防误触移动，配合视觉状态指示
- 外观控制：字体（大小/字重/设计）、12/24 小时制、秒/日期、透明度、阴影、背景
- 全局快捷键：默认 Cmd+Ctrl+L（锁定/解锁），Cmd+Ctrl+T（切换穿透）
- 稳定可靠：智能监听全屏与空间变化，动态调整窗口层级
- 本地化与低干扰：遵循系统外观与区域设置，尽量降低资源占用

> 说明：多显示器基础支持、开机启动、截图/录屏排除等高级功能在路线图中，部分已进行中。

---

## 安装与构建
### 环境要求
- macOS 15.5 及以上（开发日志当前标注的最低支持版本）
- Xcode 16 及以上
- Swift 5

### 获取代码
```bash
# 使用 SSH 或 HTTPS 克隆仓库
git clone <your-repo-url>
cd CornerTime
```

### 打开工程与运行
1. 使用 Xcode 打开仓库根目录下的工程文件（`.xcodeproj` 或 `.xcworkspace`，以实际为准）
2. 选择 `CornerTime` 目标（Scheme）
3. 直接运行（⌘R）或打包构建（⌘B）

> 项目采用原生 API，无需额外第三方依赖（后续如引入，将通过 Swift Package Manager 管理）。

---

## 使用指南
- 拖拽移动：在时钟区域按下并拖动即可移动位置
- 智能吸附：靠近屏幕边缘会进行磁性吸附，支持 8 个方向
- 位置记忆：窗口位置会被自动保存与恢复
- 安全区：刘海屏与系统 UI 区域会自动避让
- 点击穿透：通过设置或快捷键切换，避免遮挡前景交互
- 位置锁定：锁定后无法拖动，防止误操作
- 快捷键（默认）：
  - Cmd+Ctrl+L：锁定/解锁位置
  - Cmd+Ctrl+T：切换点击穿透
- 设置面板：右键菜单进入外观与行为设置，所见即所得实时预览

> 后续版本将提供更多可自定义的快捷键与菜单栏入口（可选）。

---

## 设置项（偏好）
设置分为以下分类（详见界面与实现）：
- 外观（Appearance）：字体、大小、字重、12/24h、显示秒/日期/星期、透明度、背景与圆角等
- 行为（Behavior）：点击穿透、锁定位置、显示/隐藏快捷键、开机启动、截图/录屏中隐藏等
- 显示器（Display）：所有显示器显示 / 仅主显示器 / 固定到指定显示器（按屏幕 UUID 记忆）
- 高级（Advanced）：刷新频率、节能策略、调试日志、重置全部设置

配置持久化使用 `UserDefaults`，关键数据结构由 `PreferencesManager` 管理，采用可迁移的配置版本策略。

---

## 多显示器支持
- 目标能力：
  - “所有显示器显示” 或 “仅主显示器”
  - 固定到某一台显示器（按屏幕 UUID 保存位置）
  - 监听显示器拓扑变化（接入/拔出、主屏变化），自动迁移与恢复
- 当前状态：基础支持正在完善中（详见 [开发需求](开发需求.md) 与 [开发日志](开发日志.md)）

---

## 架构与目录结构
项目采用 MVVM 架构与模块化设计，SwiftUI + AppKit 混合实现：

- Core（核心业务）：
  - `ClockCore.swift`：时间逻辑、格式化、多时区处理
  - `WindowManager.swift`：窗口层级、位置管理、空间行为
  - `PreferencesManager.swift`：配置读写与持久化
  - `DisplayManager.swift`：多显示器检测、拓扑变化监听
  - `HotKeyManager.swift`：全局快捷键注册与处理
  - `AppLifecycle.swift`：启动项管理、应用状态控制
- ViewModels：
  - `ClockViewModel.swift`
- Views：
  - `ClockView.swift`：时钟显示视图
  - `ClockWindowController.swift`：窗口控制器
  - `AppearancePanel.swift`：外观设置面板

示例目录结构：
```text
CornerTime/
├── Core/
│   ├── ClockCore.swift
│   ├── WindowManager.swift
│   ├── PreferencesManager.swift
│   ├── DisplayManager.swift
│   ├── HotKeyManager.swift
│   └── AppLifecycle.swift
├── ViewModels/
│   └── ClockViewModel.swift
├── Views/
│   ├── ClockView.swift
│   └── ClockWindowController.swift
└── CornerTimeApp.swift
```

---

## 技术要点
- 窗口层级：使用 `NSWindow.Level.statusBar` 确保在全屏应用之上展示
- 空间行为：`canJoinAllSpaces`、`fullScreenAuxiliary`、`stationary` 等组合实现多空间与全屏可见
- 安全区与吸附：支持刘海/系统 UI 避让与 8 向磁性吸附
- 性能与能耗：按需刷新（是否显示秒）、后台降低频率、兼容 App Nap
- 稳定性：监听全屏/空间/显示器变化，及时更新窗口属性，避免闪烁与丢失
- 日志：基于 OSLog，分级输出关键事件（窗口层级、显示器事件、配置读写等）

---

## 路线图
按优先级与阶段规划（节选）：
- MVP（进行中）
  - 置顶透明窗口 + 全屏/多空间可见
  - 位置记忆 + 吸附 + 安全区
  - 点击穿透 & 锁定
  - 基础外观控制（字体大小、12/24h、秒/日期）
  - 多显示器基础支持
  - 全局快捷键
  - 开机启动
  - 截图/录屏排除（基础）
- v1.0（计划）
  - 皮肤与毛玻璃
  - 世界时钟（最多 3 个）
  - 专注模式自动隐藏
  - 更完善的本地化与无菜单栏图标模式

详尽需求见：[开发需求](开发需求.md)

---

## 更新日志与问题修复
- 开发历程与阶段成果：见 [开发日志](开发日志.md)
- 关键问题与修复小结：见 [BUG_FIXES_SUMMARY.md](BUG_FIXES_SUMMARY.md)

其中已完成的关键修复包括：
- 启动崩溃（初始化顺序）修复
- 拖拽坐标与吸附行为修复
- 手势识别器与配置同步修复

---

## 贡献
欢迎提交 Issue 与 Pull Request：
- 保持单次 PR 规模适中（建议 < 500 行变更）
- 尽量附带必要的说明、截图或录屏
- 通过基本的构建与可运行性校验

如需讨论架构或规划，建议先开 Issue 以便对齐方向。

---

## 许可证
尚未设置许可证。若需使用或分发，请先与作者沟通或等待仓库更新 `LICENSE` 文件。

---

## 致谢
- Apple 原生框架：SwiftUI + AppKit
- 以及所有提出建议与反馈的朋友们 🙏